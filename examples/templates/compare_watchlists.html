<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchlist Comparison - {{ username }}</title>
    <style>
        :root { 
            caret-color: transparent;
            --bg-color: #0d1117;
            --card-bg: rgba(22, 27, 34, 0.7);
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --link-color: #58a6ff;
            --accent-color: #238636;
            --hover-bg: rgba(177, 186, 196, 0.04);
            --badge-bg: rgba(56, 139, 253, 0.15);
            --badge-text: #58a6ff;
            --badge-hover: rgba(56, 139, 253, 0.3);
            --input-bg: #0d1117;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            background-image: radial-gradient(circle at top right, #161b22 0%, transparent 40%), radial-gradient(circle at bottom left, #161b22 0%, transparent 40%);
            background-attachment: fixed;
            min-height: 100vh;
            font-size: 13px;
            cursor: default;
        }
        .header, h1, .stat-item, th, .rank, .count-badge, .year, .users-cell {
            user-select: none;
            -webkit-user-select: none;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .header {
            background: rgba(22, 27, 34, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        
        .filter-bar {
            display: flex; gap: 12px; align-items: center;
            padding-top: 12px; border-top: 1px solid var(--border-color);
        }
        
        select, button {
            background: var(--input-bg); border: 1px solid var(--border-color);
            color: var(--text-primary); padding: 6px 12px; border-radius: 6px;
            font-size: 13px; outline: none;
        }
        select:focus { border-color: var(--link-color); }
        
        .toggle-group {
            display: flex; background: var(--input-bg);
            border: 1px solid var(--border-color); border-radius: 6px; padding: 2px;
        }
        .toggle-btn {
            border: none; background: transparent; padding: 4px 12px;
            cursor: pointer; color: var(--text-secondary); border-radius: 4px;
        }
        .toggle-btn.active { background: var(--badge-bg); color: var(--badge-text); font-weight: 600; }
        
        h1 { margin: 0; font-size: 20px; font-weight: 600; }
        .username { color: var(--link-color); }
        
        .stats { display: flex; gap: 15px; font-size: 13px; color: var(--text-secondary); }
        .stat-item strong { color: var(--text-primary); display: inline; font-size: 14px; margin-right: 4px; }
        
        .table-container {
            background: var(--card-bg); backdrop-filter: blur(8px);
            border: 1px solid var(--border-color); border-radius: 8px;
            overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        table { border-collapse: collapse; width: 100%; }
        th { 
            text-align: left; padding: 0;
            background: rgba(22, 27, 34, 0.8); border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary); font-weight: 600; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.5px;
            position: relative;
        }
        .sort-btn {
            width: 100%; text-align: left; background: none; border: none;
            color: inherit; font-family: inherit; font-size: inherit; font-weight: inherit;
            text-transform: inherit; letter-spacing: inherit; padding: 12px;
            cursor: pointer; display: flex; align-items: center; justify-content: space-between;
            outline: none; transition: background 0.2s, color 0.2s;
        }
        .sort-btn:hover { color: var(--text-primary); background: rgba(33, 38, 45, 0.8); }
        .sort-btn:focus-visible { background: rgba(33, 38, 45, 1); box-shadow: inset 0 0 0 1px var(--link-color); }
        
        .sort-icon { opacity: 0.2; font-size: 10px; transition: opacity 0.2s; }
        .sort-btn:hover .sort-icon { opacity: 0.5; }
        .sort-asc .sort-icon, .sort-desc .sort-icon { opacity: 1; color: var(--link-color); }
        .sort-asc .sort-icon::after { content: '↑'; }
        .sort-desc .sort-icon::after { content: '↓'; }
        .sort-icon::after { content: '↕'; }

        td { 
            padding: 8px 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: var(--hover-bg); }
        
        .rank { color: var(--text-secondary); width: 40px; font-family: monospace; font-size: 12px; text-align: center; }
        .percentage { color: var(--text-secondary); width: 80px; font-family: monospace; font-size: 12px; text-align: center; }
        .count { white-space: nowrap; width: 80px; }
        .count-badge { 
            background: rgba(110, 118, 129, 0.4);
            color: var(--text-primary); 
            padding: 2px 8px;
            border-radius: 12px; 
            font-weight: 500; 
            font-size: 11px;
            border: 1px solid transparent;
        }
        
        .film-link { 
            color: var(--text-primary); text-decoration: none;
            font-weight: 600; font-size: 14px; display: inline-block;
        }
        .film-link:hover { color: var(--link-color); text-decoration: underline; }
        .year { font-size: 12px; color: var(--text-secondary); font-weight: normal; margin-left: 6px; }
        
        .users-cell { width: 50%; vertical-align: top; padding-top: 12px; }
        .users-wrapper { display: flex; flex-wrap: wrap; gap: 4px; }
        .user-badge { 
            display: inline-block; background: var(--badge-bg); color: var(--badge-text);
            padding: 2px 8px; border-radius: 12px; font-size: 11px;
            text-decoration: none; transition: all 0.2s; border: 1px solid transparent;
        }
        .user-badge:hover { 
            background: var(--badge-hover); border-color: rgba(88, 166, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .hidden { display: none; }
        #match-count { 
            color: var(--text-secondary); 
            font-size: 12px;
            margin-left: auto; 
        }
        
        .tabs { 
            display: inline-flex; 
            background: rgba(110, 118, 129, 0.1); 
            border-radius: 6px; 
            padding: 4px; 
            margin-bottom: 16px; 
            border: 1px solid var(--border-color);
        }
        .tab-btn { 
            background: none; 
            border: none; 
            color: var(--text-secondary); 
            padding: 6px 16px; 
            font-size: 13px; 
            cursor: pointer; 
            border-radius: 5px;
            font-weight: 500; 
            transition: all 0.2s; 
            display: flex; align-items: center; gap: 8px;
        }
        .tab-btn:hover { 
            color: var(--text-primary); 
            background: rgba(177, 186, 196, 0.08); 
        }
        .tab-btn.active { 
            background: rgba(110, 118, 129, 0.3);
            color: var(--text-primary); 
            font-weight: 600; 
            box-shadow: none;
        }
        .tab-btn svg { fill: currentColor; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .user-link { color: var(--text-primary); font-weight: 600; text-decoration: none; }
        .user-link:hover { color: var(--link-color); text-decoration: underline; }

        /* Template Notice - Only visible when NOT rendered via Python */
        /* Fullscreen Template Overlay - Only visible when NOT rendered via Python */
        .template-notice {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(13, 17, 23, 0.9); backdrop-filter: blur(12px);
            z-index: 9999; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            text-align: center; color: #ff7b72; padding: 20px; box-sizing: border-box;
        }
        .template-card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            padding: 40px; border-radius: 12px; max-width: 440px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            display: flex; flex-direction: column; align-items: flex-start;
            text-align: left;
        }
        .template-badge {
            background: var(--hover-bg); border: 1px solid var(--border-color);
            padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; 
            gap: 8px; margin-bottom: 24px; color: var(--link-color); font-size: 11px;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .template-title { font-size: 22px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }
        .template-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 24px; }
        
        .process-list { list-style: none; padding: 0; margin: 0 0 32px 0; }
        .process-item { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 14px; color: var(--text-secondary); font-size: 13px; }
        .process-item svg { margin-top: 2px; flex-shrink: 0; color: var(--link-color); }

        .terminal-box { width: 100%; }
        .terminal-content {
            background: var(--input-bg); border: 1px solid var(--border-color);
            padding: 14px 16px; border-radius: 8px;
            font-family: 'SFMono-Regular', Consolas, monospace; font-size: 12px;
        }
        
        .card-footer { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 32px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .card-footer a { color: var(--link-color); text-decoration: none; font-size: 12px; font-weight: 500; }
        .dismiss-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 12px; text-decoration: underline; opacity: 0.7; padding: 0; }
        .dismiss-btn:hover { opacity: 1; color: var(--text-primary); }



        .films-cell { padding: 12px; vertical-align: top; }
        .films-wrapper { 
            display: flex; flex-wrap: wrap; gap: 4px; 
            max-width: 100%;
        }
        .film-badge {
            display: inline-block; background: rgba(110, 118, 129, 0.15); color: var(--text-primary);
            padding: 2px 8px; border-radius: 12px; font-size: 11px;
            text-decoration: none; border: 1px solid transparent;
            white-space: nowrap;
        }
        .film-badge:hover { 
            color: var(--link-color); background: rgba(56, 139, 253, 0.2); border-color: rgba(56, 139, 253, 0.4);
        }
        .extra-film { display: none; }
        .films-wrapper.expanded .extra-film { display: inline-block; }

        .more-badge {
            background: var(--hover-bg); border: 1px dashed var(--border-color);
            color: var(--link-color); cursor: pointer; font-weight: 600;
        }
        .more-badge:hover { background: var(--badge-bg); border-style: solid; }
        .films-wrapper.expanded .more-badge { display: none; }
        
        .show-less-btn {
            display: none; background: none; border: none; color: var(--text-secondary);
            font-size: 10px; text-decoration: underline; cursor: pointer; margin-top: 4px;
            width: 100%; text-align: left; padding: 0;
        }
        .films-wrapper.expanded + .show-less-btn { display: block; }

        /* Scroll to Top Button */
        #scrollTopBtn {
            position: fixed; bottom: 30px; right: 30px; z-index: 1000;
            background: var(--link-color); color: white; border: none; outline: none;
            width: 48px; height: 48px; border-radius: 50%; cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; justify-content: center; 
            opacity: 0; transform: translateY(20px); pointer-events: none;
        }
        #scrollTopBtn.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        #scrollTopBtn:hover { background: #79c0ff; transform: scale(1.1); }
        #scrollTopBtn svg { width: 24px; height: 24px; fill: currentColor; }

    </style>
</head>
<body>
    <div class="container">
    {% if not username %}
    <div id="template-notice" class="template-notice">
        <div class="template-card">
            <div class="template-badge">
                <svg aria-hidden="true" height="14" viewBox="0 0 16 16" width="14" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>
                Jinja2 Blueprint
            </div>
            
            <div class="template-title">Report Template</div>
            <div class="template-desc">
                This file is a dynamic template used by the analysis engine. 
                It requires a data payload to render the full watchlist comparison results.
            </div>

            <ul class="process-list">
                <li class="process-item">
                    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" width="16" fill="currentColor"><path d="M0 3.75C0 2.784.784 2 1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25Zm1.75-.25a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25ZM3.5 6.25a.75.75 0 0 1 .75-.75h7a.75.75 0 0 1 0 1.5h-7a.75.75 0 0 1-.75-.75Zm0 3.5a.75.75 0 0 1 .75-.75h4a.75.75 0 0 1 0 1.5h-4a.75.75 0 0 1-.75-.75Z"></path></svg>
                    <span>Script fetches data via <strong>letterboxdpy</strong></span>
                </li>
                <li class="process-item">
                    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" width="16" fill="currentColor"><path d="M7 6.5C7 5.672 7.672 5 8.5 5s1.5.672 1.5 1.5S9.328 8 8.5 8 7 7.328 7 6.5Zm3 0C10 7.88 8.88 9 7.5 9S5 7.88 5 6.5 6.12 4 7.5 4 10 5.12 10 6.5ZM7 13c0-1.105 1.343-2 3-2s3 .895 3 2c0 .734-.597 1-1 1H8c-.403 0-1-.266-1-1Zm3-3c-2.209 0-4 1.343-4 3 0 1.552 1.343 2 3 2h5c1.657 0 3-.448 3-2 0-1.657-1.791-3-4-3h-3ZM0 12c0-1.105 1.343-2 3-2h1v1.5c0 .285.083.543.226.75H3c-.403 0-1 .266-1 1 0 .734.597 1 1 1h.5a.75.75 0 0 1 0 1.5H3c-1.657 0-3-.448-3-2Zm3-9c1.657 0 3 1.343 3 3S4.657 9 3 9 0 7.657 0 6s1.343-3 3-3Zm0 1.5c-.828 0-1.5.672-1.5 1.5S2.172 7.5 3 7.5 4.5 6.828 4.5 6 3.828 4.5 3 4.5Z"></path></svg>
                    <span>Analyzer processes shared watchlists</span>
                </li>
                <li class="process-item">
                    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" width="16" fill="currentColor"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0 1 14.25 16H1.75A1.75 1.75 0 0 1 0 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V1.75a.25.25 0 0 0-.25-.25ZM3.5 7.75h9a.75.75 0 0 1 0 1.5h-9a.75.75 0 0 1 0-1.5ZM3 5.75a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5h-4.5A.75.75 0 0 1 3 5.75Zm0 4a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1-.75-.75Z"></path></svg>
                    <span><strong>Jinja2</strong> renders the final report</span>
                </li>
            </ul>

            <div class="terminal-box">
                <div class="terminal-content">
                    <span style="color: var(--text-secondary);">$</span> python compare_watchlists.py <span style="color: var(--badge-hover);">-u</span> <span style="color: var(--link-color);">USER_NAME</span>
                </div>
            </div>
            
            <div class="card-footer">
                <a href="https://github.com/fastfingertips/letterboxdpy" target="_blank">Documentation →</a>
                <button class="dismiss-btn" onclick="document.getElementById('template-notice').style.display='none'">Dismiss to view raw source</button>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="header">
            <div class="header-top">
                <div>
                    <h1>Watchlist Comparison</h1>
                    <div style="margin-top: 4px; color: var(--text-secondary);">
                        for <span class="username">@{{ username }}</span>
                    </div>
                </div>
                <div class="stats">
                    <div class="stat-item"><strong>{{ stats.watchlist }}</strong> in watchlist</div>
                    <div class="stat-item"><strong>{{ stats.following }}</strong> scanned</div>
                    <div class="stat-item"><strong>{{ stats.matches }}</strong> matches</div>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" data-tab="tab-films" onclick="switchTab('tab-films')">
                    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 3.75C0 2.784.784 2 1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25v-8.5Zm1.75-.25a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25Z"></path><path d="M3.5 6.5a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 .75.75v1a.75.75 0 0 1-.75.75h-1a.75.75 0 0 1-.75-.75v-1ZM8 5.75a.75.75 0 0 0-.75.75v1c0 .414.336.75.75.75h1a.75.75 0 0 0 .75-.75v-1a.75.75 0 0 0-.75-.75h-1Zm2.75.75a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 .75.75v1a.75.75 0 0 1-.75.75h-1a.75.75 0 0 1-.75-.75v-1ZM3.5 9.75a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 .75.75v1a.75.75 0 0 1-.75.75h-1a.75.75 0 0 1-.75-.75v-1ZM8 9a.75.75 0 0 0-.75.75v1c0 .414.336.75.75.75h1a.75.75 0 0 0 .75-.75v-1A.75.75 0 0 0 9 9h-1Zm2.75.75a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 .75.75v1a.75.75 0 0 1-.75.75h-1a.75.75 0 0 1-.75-.75v-1Z"></path></svg>
                    Films
                </button>
                <button class="tab-btn" data-tab="tab-users" onclick="switchTab('tab-users')">
                    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.508 5.508 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4.002 4.002 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.493 3.493 0 0 1 2 5.5ZM11 4a3.001 3.001 0 0 1 2.22 5.018 5.01 5.01 0 0 1 2.56 3.012.749.749 0 0 1-.885.954.752.752 0 0 1-.549-.514 3.507 3.507 0 0 0-2.522-2.372.75.75 0 0 1-.574-.73v-.352a.75.75 0 0 1 .416-.672A1.5 1.5 0 0 0 11 2.5.75.75 0 0 1 11 1h.5a3 3 0 0 1-.5 3Zm-5.5 1.5a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"></path></svg>
                    Users
                </button>
            </div>
            
            <div class="filter-bar">
                <span style="color: var(--text-secondary); font-weight: 600;">Filter by User:</span>
                <select id="userSelect" onchange="applyFilter()">
                    <option value="">All Users</option>
                    {% for user in all_users|sort %}
                    <option value="{{ user }}">{{ user }}</option>
                    {% endfor %}
                </select>
                
                <div class="toggle-group">
                    <button id="btnInclude" class="toggle-btn active" onclick="setMode('include')">Must have</button>
                    <button id="btnExclude" class="toggle-btn" onclick="setMode('exclude')">Must NOT have</button>
                </div>
                
            <div id="match-count">Showing all films</div>
            </div>
        </div> <!-- .header closing -->
        
        <div id="tab-films" class="tab-content active">
            <div class="table-container">
                <table id="filmsTable">
                    <thead>
                        <tr>
                            <th>
                                <button class="sort-btn" onclick="sortTable('filmsTable', 0, 'num')">
                                    # <span class="sort-icon"></span>
                                </button>
                            </th>
                            <th>
                                <button class="sort-btn" onclick="sortTable('filmsTable', 1, 'num')">
                                    Matches <span class="sort-icon"></span>
                                </button>
                            </th>
                            <th>
                                <button class="sort-btn" onclick="sortTable('filmsTable', 2, 'str')">
                                    Film <span class="sort-icon"></span>
                                </button>
                            </th>
                            <th style="padding: 12px;">Wanted by (Following)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for film in films %}
                        <tr data-users="{{ film.users_csv }}">
                            <td class="rank">#{{ loop.index }}</td>
                            <td class="count"><span class="count-badge">{{ film.count }}</span></td>
                            <td class="film">
                                <a href="{{ film.url }}" target="_blank" class="film-link">{{ film.name }}</a>
                                <span class="year">({{ film.year }})</span>
                            </td>
                            <td class="users-cell">
                                <div class="users-wrapper">
                                    {% for user in film.users %}
                                    <a href="https://letterboxd.com/{{ user }}/" target="_blank" class="user-badge">{{ user }}</a>
                                    {% endfor %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="tab-users" class="tab-content">
            <div class="table-container">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>
                                <button class="sort-btn" onclick="sortTable('usersTable', 0, 'num')">
                                    # <span class="sort-icon"></span>
                                </button>
                            </th>
                            <th>
                                <button class="sort-btn" onclick="sortTable('usersTable', 1, 'num')">
                                    Matches <span class="sort-icon"></span>
                                </button>
                            </th>
                            <th>
                                <button class="sort-btn" onclick="sortTable('usersTable', 2, 'num')">
                                    Sharing % <span class="sort-icon"></span>
                                </button>
                            </th>
                            <th>
                                <button class="sort-btn" onclick="sortTable('usersTable', 3, 'str')">
                                    User <span class="sort-icon"></span>
                                </button>
                            </th>
                            <th style="padding: 12px;">Common Films</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td class="rank">#{{ loop.index }}</td>
                            <td class="count">
                                <span class="count-badge">{{ user.matches_count }}</span>
                                <span style="font-size: 10px; opacity: 0.5; margin-left: 4px;">/ {{ user.total_count }}</span>
                            </td>
                            <td class="percentage">{{ user.percentage }}%</td>
                            <td class="user-col">
                                <a href="{{ user.url }}" target="_blank" class="user-link">@{{ user.name }}</a>
                            </td>
                            <td class="films-cell">
                                <div class="films-wrapper">
                                    {% for film in user.shared_films %}
                                        <a href="{{ film.url }}" target="_blank" class="film-badge {% if loop.index > 12 %}extra-film{% endif %}">{{ film.name }}</a>
                                    {% endfor %}
                                    {% if user.shared_films|length > 12 %}
                                        <button class="film-badge more-badge" onclick="toggleFilms(this)">
                                            + {{ user.shared_films|length - 12 }} more
                                        </button>
                                    {% endif %}
                                </div>
                                {% if user.shared_films|length > 12 %}
                                    <button class="show-less-btn" onclick="toggleFilms(this.previousElementSibling.querySelector('.more-badge'))">Show less</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div style="text-align: center; margin-top: 30px; color: var(--text-secondary); font-size: 12px;">
            Generated with letterboxdpy · {{ stats.generated_at }}
        </div>

    <button id="scrollTopBtn" onclick="scrollToTop()" title="Go to top">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5H7z"/></svg>
    </button>

    <script>
        let filterMode = 'include';
        
        function setMode(mode) {
            filterMode = mode;
            document.getElementById('btnInclude').classList.toggle('active', mode === 'include');
            document.getElementById('btnExclude').classList.toggle('active', mode === 'exclude');
            applyFilter();
        }
        
        function applyFilter() {
            const selectedUser = document.getElementById('userSelect').value;
            const rows = document.querySelectorAll('#filmsTable tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const users = row.dataset.users.split(',');
                let show = true;
                
                if (selectedUser) {
                    const hasUser = users.includes(selectedUser);
                    if (filterMode === 'include') {
                        show = hasUser;
                    } else {
                        show = !hasUser;
                    }
                }
                
                if (show) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            });
            
            let countText = '';
            if (selectedUser) {
                if (filterMode === 'include') {
                    countText = `Found ${visibleCount} films wanted by ${selectedUser}`;
                } else {
                    countText = `Found ${visibleCount} films NOT wanted by ${selectedUser}`;
                }
            } else {
                countText = `Showing all ${visibleCount} films`;
            }
                
            document.getElementById('match-count').textContent = countText;
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const filterBar = document.querySelector('.filter-bar');
            if (tabId === 'tab-films') {
                filterBar.style.display = 'flex';
            } else {
                filterBar.style.display = 'none';
            }
        }
        
        const sortStates = {};
        function sortTable(tableId, n, type) {
            const table = document.getElementById(tableId);
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);
            const stateKey = `${tableId}-${n}`;
            const dir = sortStates[stateKey] === 'asc' ? 'desc' : 'asc';
            sortStates[stateKey] = dir;
            
            table.querySelectorAll('.sort-btn').forEach(btn => btn.closest('th').classList.remove('sort-asc', 'sort-desc'));
            table.querySelectorAll('thead th')[n].classList.add(dir === 'asc' ? 'sort-asc' : 'sort-desc');

            rows.sort((a, b) => {
                let x = a.cells[n].innerText.replace('#', '').trim();
                let y = b.cells[n].innerText.replace('#', '').trim();
                
                if (type === 'num') {
                    if (x.includes('/')) x = x.split('/')[0].trim();
                    if (y.includes('/')) y = y.split('/')[0].trim();
                    x = Number.parseFloat(x.replaceAll(/[^\d.-]/g, '')) || 0;
                    y = Number.parseFloat(y.replaceAll(/[^\d.-]/g, '')) || 0;
                } else {
                    x = x.toLowerCase();
                    y = y.toLowerCase();
                }
                
                if (dir === 'asc') return x > y ? 1 : -1;
                return x < y ? 1 : -1;
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function toggleFilms(btn) {
            const wrapper = btn.closest('.films-wrapper') || btn.nextElementSibling;
            const isExpanding = !wrapper.classList.contains('expanded');
            
            // Close all other expanded rows
            document.querySelectorAll('.films-wrapper.expanded').forEach(w => {
                if (w !== wrapper) {
                    w.classList.remove('expanded');
                }
            });

            // Toggle current
            wrapper.classList.toggle('expanded', isExpanding);
        }

        // Scroll to Top logic
        window.addEventListener('scroll', () => {
            const btn = document.getElementById("scrollTopBtn");
            if (!btn) return;
            if (window.scrollY > 400) {
                btn.classList.add("visible");
            } else {
                btn.classList.remove("visible");
            }
        });

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
